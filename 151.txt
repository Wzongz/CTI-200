{
  "event_id": "151",
  "claim": " Turla, also known as Snake, is an infamous espionage group recognized for its complex malware.",
  "original_label": "true",
  "label": "true",
  "explain": "Turla, also known as Snake, is an infamous espionage group recognized for its complex malware. To confound detection, its operators recently started using PowerShell scripts that provide direct, in-memory loading and execution of malware executables and libraries. This allows them to bypass detection that can trigger when a malicious executable is dropped on disk. Turla is believed to have been operating since at least 2008, when it successfully breached the US military. More recently, it was involved in major attacks against the German Foreign Office and the French military. This is not the first time Turla has used PowerShell in-memory loaders to increase its chances of bypassing security products. In 2018, Kaspersky Labs published a report that analyzed a Turla PowerShell loader that was based on the open-source project Posh-SecMod. However, it was quite buggy and often led to crashes. After a few months, Turla has improved these scripts and is now using them to load a wide range of custom malware from its traditional arsenal. The victims are quite usual for Turla. We identified several diplomatic entities in Eastern Europe that were compromised using these scripts. However, it is likely the same scripts are used more globally against many traditional Turla targets in Western Europe and the Middle East. Thus, this blogpost aims to help defenders counter these PowerShell scripts. We will also present various payloads, including an RPC-based backdoor and a backdoor leveraging OneDrive as its Command and Control (C&C) server.The PowerShell loader has three main steps: persistence, decryption and loading into memory of the embedded executable or library.The PowerShell scripts are not simple droppers; they persist on the system as they regularly load into memory only the embedded executables. We have seen Turla operators use two persistence methods:In the first case, attackers create two WMI event filters and two WMI event consumers. The consumers are simply command lines launching base64-encoded PowerShell commands that load a large PowerShell script stored in the Windows registry. Figure 1 shows how the persistence is established.These events will run respectively at 15:30:40 and when the system uptime is between 300 and 400 seconds. The variable $HL39fjh contains the base64-encoded PowerShell command shown in Figure 2. It reads the Windows Registry key where the encrypted payload is stored, and contains the password and the salt needed to decrypt the payload.Finally, the script stores the encrypted payload in the Windows registry. Note that the attackers seem to use a different registry location per organization. Thus, it is not a useful indicator to detect similar intrusions.The payload stored in the Windows registry is another PowerShell script. It is generated using the open-source script Out-EncryptedScript.ps1 from the Penetration testing framework PowerSploit. In addition, the variable names are randomized to obfuscate the script, as shown in Figure 4.The payload is decrypted using the 3DES algorithm. The Initialization Vector, PINGQXOMQFTZGDZX in this example, is different for each sample. The key and the salt are also different for each script and are not stored in the script, but only in the WMI filter or in the profile.ps1 file. The payload decrypted at the previous step is a PowerShell reflective loader. It is based on the script Invoke-ReflectivePEInjection.ps1 from the same PowerSploit framework. The executable is hardcoded in the script and is loaded directly into the memory of a randomly chosen process that is already running on the system. In some samples, the attackers specify a list of executables that the binary should not be injected into, as shown in Figure 5.It is interesting to note that the names avp.exe, avpsus.exe, klnagent.exe and vapm.exe refer to Kaspersky Labs executables. It seems that Turla operators really want to avoid injecting their malware into Kaspersky software.In some samples deployed since March 2019, Turla developers modified their PowerShell scripts in order to bypass the Antimalware Scan Interface (AMSI). This is an interface allowing any Windows application to integrate with the installed antimalware product. It is particularly useful for PowerShell and macros. They did not find a new bypass but re-used a technique presented at Black Hat Asia 2018 in the talk The Rise and Fall of AMSI. It consists of the in-memory patching of the beginning of the function AmsiScanBuffer in the library amsi.dll. The PowerShell script loads a .NET executable to retrieve the address of AmsiScanBuffer. Then, it calls VirtualProtect to allow writing at the retrieved address. Finally, the patching is done directly in the PowerShell script as shown in Figure 6. It modifies the beginning of AmsiScanBuffer to always return 1 (AMSI_RESULT_NOT_DETECTED). Thus, the antimalware product will not receive the buffer, which prevents any scanning.The PowerShell scripts we have presented are generic components used to load various payloads, such as an RPC Backdoor and a PowerShell backdoor.Turla has developed a whole set of backdoors relying on the RPC protocol. These backdoors are used to perform lateral movement and take control of other machines in the local network without relying on an external C&C server. The features implemented are quite basic: file upload, file download and command execution via cmd.exe or PowerShell. However, the malware also supports the addition of plugins. This RPC backdoor is split into two components: a server and a client. An operator will use the client component to execute commands on another machine where the server component exists, as summarized in Figure 7.For instance, the sample identified by the following SHA-1 hash EC54EF8D79BF30B63C5249AF7A8A3C652595B923 is a client version. This component opens the named pipe \\pipe\\atctl with the protocol sequence being “ncacn_np” via the RpcStringBindingComposeW function. The sample can then send commands by calling the NdrClientCall2 function. The exported procedure HandlerW , responsible for parsing the arguments, shows that it is also possible to try to impersonate an anonymous token or try to steal another’s process token just for the execution of a command. Its server counterpart does the heavy lifting and implements the different commands. It first checks if the registry key value HKLM\\SYSTEM\\CurrentControlSet\\services\\LanmanServer\\Parameters\\NullSessionPipes contains “atctl”. If so, the server sets the security descriptor on the pipe object to “S:(ML;;NW;;;S-1-16-0)” via the SetSecurityInfo function. This will make the pipe available to everyone (untrusted/anonymous integrity level). The following image shows the corresponding MIDL stub descriptor and the similar syntax and interface ID.As mentioned previously, this backdoor also supports loading plugins. The server creates a thread that searches for files matching the following pattern lPH*.dll. If such a file exists, it is loaded and its export function ModuleStart is called. Among the various plugins we have located so far, one is able to steal recent files and files from USB thumb drives. Many variants of this RPC backdoor are used in the wild. Among some of them, we have seen local proxies (using upnprpc as the endpoint and ncalrpc as the protocol sequence) and newer versions embedding PowerShellRunner to run scripts directly without using powershell.exe.The main purpose of this utility is to retrieve the RPC configuration of a process that has registered an interface. In order to find that kind of process, it iterates through the TCP table (via the GetTcpTable2 function) until it either finds the PID of the process that has opened a specific port, or retrieves the PID of the process that has opened a specific named pipe. Once this PID is found, this utility reads the remote process’ memory and tries to retrieve the registered RPC interface. The code for this, seen in Figure 9, seems ripped from this Github repository.At first we were unsure how the retrieved information was used but then another sample, (SHA-1: B948E25D061039D64115CFDE74D2FF4372E83765) helped us understand. As shown in Figure 10, this sample retrieves the RPC interface, unsets the flag to RPC_IF_ALLOW_SECURE_ONLY, and patches the “dispatch table” in memory using the WriteProcessMemory function. Those operations would allow the sample to add its RPC functions to an already existing RPC interface. We believe it is stealthier to re-use an existing RPC interface than to create a custom one.PowerStallion is a lightweight PowerShell backdoor using Microsoft OneDrive, a storage service in the cloud, as C&C server. The credentials are hardcoded at the beginning of the script, as shown in Figure 11.It is interesting to note that Turla operators used the free email provider GMX again, as in the Outlook Backdoor and in LightNeuron. They also used the name of a real employee of the targeted organization in the email address. Then it uses a net use command to connect to the network drive. It then checks, in a loop, as shown in Figure 12, if a command is available. This backdoor can only execute additional PowerShell scripts. It writes the command results in another OneDrive subfolder and encrypts it with the XOR key 0xAA.Another interesting artefact is that the script modifies the modification, access and creation (MAC) times of the local log file to match the times of a legitimate file – desktop.ini in that example, as shown in Figure 13.In a 2018 blogpost, we predicted that Turla would use more and more generic tools. This new research confirms our forecast and shows that the Turla group does not hesitate to use open-source pen-testing frameworks to conduct intrusion. However, it does not prevent attributing such attacks to Turla. Attackers tend to configure or modify those open-source tools to better suit their needs. Thus, it is still possible to separate different clusters of activities. Finally, the usage of open-source tools does not mean Turla has stopped using its custom tools. The payloads delivered by the PowerShell scripts, the RPC backdoor and PowerStallion, are actually very customized. Our recent analysis of Turla LightNeuron is additional proof that this group is still developing complex, custom malware. We will continue monitoring new Turla activities and will publish relevant information on our blog. For any inquiries, contact us as threatintel@eset.com. Indicators of Compromise can also be found on our GitHub.\n\n\n",
  "reports": [
    {
      "link": "https://www.welivesecurity.com/2019/05/29/turla-powershell-usage/",
      "content": "Its developers took inspiration from other Turla backdoors, such as Snake, to build a very complex piece of malware. Moreover, there are a few elements linking ComRAT v4 to Turla: During our investigation, we were able to get insights about what Turla operators were doing on the compromised machines. The usual modus operandi of Turla’s operators is to use basic first-stage malware for initial reconnaissance. To perform these operations, Turla’s operators maintain a large arsenal of malware including a rootkit, several complex backdoors aimed at different platforms, including Microsoft Exchange mail servers, and a large range of tools to enable pivoting on a network. Turla, also known as Snake, is an infamous espionage group active for at least a decade. Turla’s operators have at their disposal a wide arsenal of malware tools for all major desktop platforms: Windows, macOS and Linux.",
      "domain": "www.welivesecurity.com",
      "tokenized": [
        {
          "sent":"Its developers took inspiration from other Turla backdoors, such as Snake, to build a very complex piece of malware.",
          "is_evidence": 1,
          "is_repeat": 0
        },
        {
          "sent":"Moreover, there are a few elements linking ComRAT v4 to Turla: During our investigation, we were able to get insights about what Turla operators were doing on the compromised machines.",
          "is_evidence": 0
        },
        {
          "sent":"The usual modus operandi of Turla’s operators is to use basic first-stage malware for initial reconnaissance.",
          "is_evidence": 0
        },
        {
          "sent": "To perform these operations, Turla’s operators maintain a large arsenal of malware including a rootkit, several complex backdoors aimed at different platforms, including Microsoft Exchange mail servers, and a large range of tools to enable pivoting on a network.",
          "is_evidence": 0
        },
        {
          "sent":"Turla, also known as Snake, is an infamous espionage group active for at least a decade.",
          "is_evidence": 0
        },
        {
          "sent":"Turla’s operators have at their disposal a wide arsenal of malware tools for all major desktop platforms: Windows, macOS and Linux.",
          "is_evidence": 0
        }
      ]
    },
    {
      "link": "https://web-assets.esetstatic.com/wls/2020/05/ESET_Turla_ComRAT.pdf/",
      "content": "Additionally, a comparison of the WhiteAtlas framework to WhiteBear components indicates that the malware is the product of separate development efforts. As a matter of fact, WhiteBear infrastructure has overlap with other Turla campaigns, like those deploying Kopiluwak, as documented in “KopiLuwak – A New JavaScript Payload from Turla” in December 2016. In addition to storing code, crypto resources, and configuration data in PE resources, WhiteBear copies much of this data to the victim host’s registry. Infrastructure overlap with other Turla campaigns, code artifacts, and targeting are consistent with past Turla efforts. Like previous Turla activity, WhiteBear leverages compromised websites and hijacked satellite connections for command and control (C2) infrastructure. With this subset of 2016-2017 WhiteBear activity, Turla continues to be one of the most prolific, longstanding, and advanced APT we have researched, and continues to be the subject of much of our research.",
      "domain": "web-assets.esetstatic.com",
      "tokenized": [
        {
          "sent": "Additionally, a comparison of the WhiteAtlas framework to WhiteBear components indicates that the malware is the product of separate development efforts.",
          "is_evidence": 1,
          "is_repeat": 0
        },
        {
          "sent":"As a matter of fact, WhiteBear infrastructure has overlap with other Turla campaigns, like those deploying Kopiluwak, as documented in “KopiLuwak – A New JavaScript Payload from Turla” in December 2016.",
          "is_evidence": 0
        },
        {
          "sent":"In addition to storing code, crypto resources, and configuration data in PE resources, WhiteBear copies much of this data to the victim host’s registry.",
          "is_evidence": 1,
          "is_repeat": 0
        },
        {
          "sent":"Infrastructure overlap with other Turla campaigns, code artifacts, and targeting are consistent with past Turla efforts.",
          "is_evidence": 1,
          "is_repeat": 0
        },
        {
          "sent": "Like previous Turla activity, WhiteBear leverages compromised websites and hijacked satellite connections for command and control (C2) infrastructure.",
          "is_evidence": 0
        },
        {
          "sent": "With this subset of 2016-2017 WhiteBear activity, Turla continues to be one of the most prolific, longstanding, and advanced APT we have researched, and continues to be the subject of much of our research.",
          "is_evidence": 0
        }
      ]
    },
    {
      "link": "https://securelist.com/introducing-whitebear/81638/",
      "content": "Adversaries like Turla often use sophisticated malware, but they also often use what is good enough to fly under the radar. Turla has many names in the information security industry — it is also known as Snake, Venomous Bear, Uroburos and WhiteBear. Turla likes to use compromised web servers and hijacked satellite connections for their command and control (C2) infrastructure. Well-known malware like Crutch or Kazuar are attributed to Turla.",
      "domain": "securelist.com",
      "tokenized": [
        {
          "sent":"Adversaries like Turla often use sophisticated malware, but they also often use what is good enough to fly under the radar.",
          "is_evidence": 1,
          "is_repeat": 0
        },
        {
          "sent":"Turla has many names in the information security industry — it is also known as Snake, Venomous Bear, Uroburos and WhiteBear.",
          "is_evidence": 0
        },
        {
          "sent":"Turla likes to use compromised web servers and hijacked satellite connections for their command and control (C2) infrastructure.",
          "is_evidence": 0
        },
        {
          "sent":  "Well-known malware like Crutch or Kazuar are attributed to Turla.",
          "is_evidence": 0
        }
      ]
    },
    {
      "link": "https://www.welivesecurity.com/2020/12/02/turla-crutch-keeping-back-door-open/",
      "content": "According to ESET LiveGrid® data, Turla used the Crutch toolset against several machines of the Ministry of Foreign Affairs in a country of the European Union. In the past few years, we have publicly documented multiple malware families operated by Turla. It has compromised many governments, especially diplomatic entities, all around the world, operating a large malware arsenal that we have described in the last years. Turla is a cyberespionage group active for more than ten years. We have seen Crutch on the network of a Ministry of Foreign Affairs in a country of the European Union, suggesting that this malware family is only used against very specific targets as is common for many Turla tools.. We identified the following similarities:Given these elements and that Turla malware families are not known to be shared among different groups, we believe that Crutch is a malware family that is part of the Turla arsenal.",
      "domain": "www.welivesecurity.com",
      "tokenized": [
        {
          "sent": "According to ESET LiveGrid® data, Turla used the Crutch toolset against several machines of the Ministry of Foreign Affairs in a country of the European Union.",
          "is_evidence": 1,
          "is_repeat": 0
        },
        {
          "sent":"In the past few years, we have publicly documented multiple malware families operated by Turla.",
          "is_evidence": 0
        },
        {
          "sent":"It has compromised many governments, especially diplomatic entities, all around the world, operating a large malware arsenal that we have described in the last years.",
          "is_evidence": 0
        },
        {
          "sent": "Turla is a cyberespionage group active for more than ten years.",
          "is_evidence": 1,
          "is_repeat": 0
        },
        {
          "sent":"We have seen Crutch on the network of a Ministry of Foreign Affairs in a country of the European Union, suggesting that this malware family is only used against very specific targets as is common for many Turla tools..",
          "is_evidence": 0
        },
        {
          "sent":  "We identified the following similarities:Given these elements and that Turla malware families are not known to be shared among different groups, we believe that Crutch is a malware family that is part of the Turla arsenal.",
          "is_evidence": 1,
          "is_repeat": 0
        }
      ]
    }
  ]
}