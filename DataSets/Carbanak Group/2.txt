From late 2013 onwards, several banks and financial institutions have been attacked by an unknown group of cybercriminals. In all these attacks, a similar modus operandi was used. According to victims and the law enforcement agencies (LEAs) involved in the investigation, this could result in cumulative losses of up to 1 billion USD. The attacks are still active. This report provides a technical analysis of these attacks. The motivation for the attackers, who are making use of techniques commonly seen in Advanced Persistent Threats (APTs), appears to be financial gain as opposed to espionage. An analysis of the campaign has revealed that the initial infections were achieved using spear phishing emails that appeared to be legitimate banking communications, with Microsoft Word 97 – 2003 (.doc) and Control Panel Applet (.CPL) files attached. We believe that the attackers also redirected to exploit kits website traffic that related to financial activity. The email attachments exploit vulnerabilities in Microsoft Office 2003, 2007 and 2010 (CVE-2012-0158 and CVE-2013-3906) and Microsoft Word (CVE-2014- 1761). Once the vulnerability is successfully exploited, the shellcode decrypts and executes the backdoor known as Carbanak. Carbanak is a remote backdoor (initially based on Carberp), designed for espionage, data exfiltration and to provide remote access to infected machines. Once access is achieved, attackers perform a manual reconnaissance of the victim’s networks. Based on the results of this operation, the attackers use different lateral movement tools in order to get access to the critical systems in the victim´s infrastructure. They then install additional software such as the Ammyy Remote Administration Tool, or even compromise SSH servers. Notably, some of the latest versions of the analyzed Carbanak malware appear not to use any Carberp source code. Once the attackers successfully compromise the victim´s network, the primary internal destinations are money processing services, Automated Teller Machines (ATM) and financial accounts. In some cases, the attackers used the Society for Worldwide Interbank Financial Telecommunication (SWIFT) network to transfer money to their accounts. In others, Oracle databases were manipulated to open payment or debit card accounts at the same bank or to transfer money between accounts using the online banking system. The ATM network was also used to dispense cash from certain ATMs at certain times where money mules were ready to collect it. As part of the attack´s reconnaissance phase, video recordings of the activities of bank employees, particularly system administrators, were made. The videos were sent to the C2 server. Please note that the attackers abused the aforementioned services by impersonating legitimate local users who had the permissions to perform the actions later reproduced by the cybercriminals. As far as we know, none of the aforementioned services were attacked nor was any specific vulnerability within them exploited. Of the 100 banking entities impacted at the time of writing this report, at least half have suffered financial losses. Most of the victims based in the geolocation of infected IPs are located in Russia, USA, Germany, China and Ukraine. That does not necessarily mean that all these victims are banking entities. The magnitude of the losses is significant. For example, one victim lost approximately $7.3 million (USD) due to ATM fraud; another suffered a $10 million (USD) loss due to the exploitation of its online banking platform. Stolen funds were transferred out of the affected countries to bank accounts in the US and China. Additionally some of the C2 servers have log entries indicating connections to systems located in the US. Telemetry indicates that the attackers are expanding operations to other regions, such as Asia, the Middle-East, Africa and Europe. This report discusses the attack vectors, infection mechanisms and toolkits used by the attackers to exploit the network after the initial infection, as well as the operational details and geographical distribution of this campaign. During the spring of 2014, Kaspersky Lab was involved in a forensic analysis of ATMs dispensing cash to people located near them but with no physical interaction according to security cameras. No malware was detected on these ATMs. However, Carberp-like malware was found on a computer that was connected to them via VPN. Following the investigation of this incident, in the summer of 2014, Kaspersky Lab identified the same Carberp-like malware in another investigation involving a bank, where criminals were able to gain access to its online banking systems. In this investigation, we started analyzing all the computers in the bank’s infrastructure in order to find the source of the infection. We found spear phishing emails with CPL files attached that, after a successful infection, install the same Carberp-like malware we had previously found in the case involving the ATMs. There is evidence indicating that in most cases the network was compromised for between two to four months, and that many hundreds of computers within a single victim organization may have been infected. This period of time was used by the attackers to get access to the right victims and critical systems, and to learn how to operate their tools and systems to get the cash out. Carbanak contains an espionage component that allows the attackers to take control of video capabilities on the victim systems. Thanks to this, long term observation and reconnaissance could be conducted. This allowed the attackers to understand the protocols and daily operational tempo of their targets. Based on this understanding, exploitation methodologies and mechanisms were developed and tailored to each victim.All observed cases used spear phishing emails with Microsoft Word 97 – 2003 (.doc) files attached or CPL files. The doc files exploit both Microsoft Office (CVE2012-0158 and CVE-2013-3906) and Microsoft Word (CVE- 2014-1761). There are indicators that point to a possible Chinese origin for the exploits used in these attachments. Command and Control (C2) servers located in China have been identified in this campaign. In addition, registration information for some of the domains use details of supposedly Chinese citizens. Obviously, all this could just be a red herring. The targets were all employees affiliated to the affected institution. The spear phishing email messages appeared legitimate and in some cases were sent from compromised coworkers´ accounts. In this way compromised systems were used as a transmission vector. Given that the victims were mostly Russian-speaking financial institutions, the names of the attachments we have identified were generally in Russian. Examples include “Соответствие ФЗ-115” and “Приглашение” which translate into “Accordance to Federal Law” and “Invitation” respectively. This is enough to induce a typical employee to open the attachment and execute the malware. For a complete list of file names see Appendix 4. The following is an example of a Carbanak spear phishing email:In this case, the attachment was a CPL file compressed using the Roshal Archive (.rar) format. Once the remote code execution vulnerability is successfully exploited, it installs Carbanak on the victim's system. The complete list of observed spear phishing emails can be found in Appendix 1 – Spear phishing. An additional infection vector that we believe was used by the criminals is a classical drive-by-download attack. We have found traces of the Null and the RedKit exploits kits.Carbanak is a backdoor used by the attackers to compromise the victim's machine once the exploit, either in the spear phishing email or exploit kit, successfully executes its payload. This section provides a functional analysis of Carbanak’s capabilities. Carbanak copies itself into “%system32%\com” with the name “svchost.exe” with the file attributes: system, hidden and read-only. The original file created by the exploit payload is then deleted. To ensure that Carbanak has autorun privileges the malware creates a new service. The naming syntax is “Sys” where ServiceName is any existing service randomly chosen, with the first character deleted. For example, if the existing service´s name is “aspnet” and the visible name is “Asp.net state service”, the service created by the malware would be “aspnetSys” with a visible name of “Sp.net state service”. Before creating the malicious service, Carbanak determines if either the avp.exe or avpui.exe processes (components of Kaspersky Internet Security) is running. If found on the target system, Carbanak will try to exploit a known vulnerability in Windows XP, Windows Server 2003, Windows Vista, Windows Server 2008, Windows 7, Windows 8, and Windows Server 2012, CVE-2013-3660, for local privilege escalation. We believe this is not relevant and that the attackers adapt their tools to the victim´s defenses. Carbanak creates a file with a random name and a .bin extension in %COMMON_APPDATA%\Mozilla where it stores commands to be executed. Then the malware gets the proxy configuration from the registry entry:Additionally, Carbanak can obtain proxy configuration information from headers sent through an application via SOCKS or HTTP. Carbanak injects its code into svchost.exe. Most of the actions described below happen within this process. Carbanak downloads the file kldconfig.plug from its C2 server. This file includes the names of the processes to be monitored. Once the system is infected, Carbanak logs keystrokes and takes screenshots every 20 seconds. This monitoring is performed by intercepting the ResumeThread call. To enable connections to the infected computer using the Remote Desktop Protocol (RDP), Carbanak sets Termservice service execution mode to Auto. Also, after executing this service, it modifies the executable code in memory in order to establish simultaneous work processes for both remote and local users. Modules modified in this process are: termsrv.dll, csrsrv.dll, msgina.dll and winlogon.exe. If Carbanak detects the banking application BLIZKO (funds transfer software) in the infected computer, it sends a special notification to its C2 server. Carbanak is also aware of the IFOBS banking application and can, on command, substitute the details of payment documents in the IFOBS system. To communicate with its C2 server, Carbanak uses the HTTP protocol with RC2+Base64 encryption, adding additional characters not included in Base64. It also inserts strings with different extensions (.gif,.htm, etc.) at random locations in the HTTP request. Example of a typical Carbanak request:It is also very interesting to see the distribution of Carbanak submissions to VirusTotal. This way we can identify periods when the malware came to the attention of potential victims and security researchers, and helps to reveal peaks in the group’s activity:Since the beginning of this case, Kaspersky Lab has worked in cooperation with the LEAs investigating it. During the investigation LEAs shared with us statistical data from their research that helped us to complete our picture of the campaign. The following map shows targets’ IP addresses found in three of Carbanak’s Linux servers at the end of October 2014:Carbanak uses different tools on infected systems, each one with a different purpose. There appears to be a preference for the Ammyy Admin remote administration tool for remote control. Specifically, the attackers have been detected uploading:It is believed that the attackers used this remote administration tool because it is commonly whitelisted in the victims’ environments as a result of being used regularly by administrators. In another instance, a Secure Shell (SSH) backdoor was used to communicate with the C2 server in 190.97.165.126 (operatemesscont.net). This indicates that the attackers did not limit themselves to Microsoft Windows environments. In this case, the victim used the Telnet/SSH client PuTTY to connect to the server, and the attackers recompiled the machine’s SSH daemon with a backdoor so they could gain direct access. Logs for these tools indicate that they were accessed from two different IPs, probably used by the attackers, and located in Ukraine and France. We have also found traces of many different tools used by the attackers inside the victim´s network to gain control of additional systems, such as Metasploit, PsExec or Mimikatz. Server rotation occurs more or less on a biweekly basis. For a complete list of identified Carbanak servers please check the regularly updated Carbanak IOC document. The current list of IOCs is provided at Appendix 3 in his document. Some of these C2 servers are responsible for dropping Ammyy (configuration and executable files), the KLG plugin configuration (list of processes to monitor) and the VNC server (both 32 and 64 bits to be injected in rundll). In one of the observed servers there was also a Metasploit module.Victim systems are catalogued in the servers’ databases. The victims belong to a number of different communities, thus simplifying administration. In all, 85 different victims belonging to seven communities were found.Additionally, the malicious servers contain video files that capture a victim´s activity. While the videos are stored using a compressed format which provides poor image quality, the selected format minimizes upload bandwith and is of sufficient quality for the attackers to understand the victims’ activities. The video file naming conventions used the name of the application in the foreground (e.g., Outlook, Cmd, etc.) and only recorded user activity. This helped the attackers to both navigate to files of interest and to discard superfluous files.Using the intelligence gained from video and other monitoring techniques, the attackers developed an operational picture of the victim's workflow, tooling and practices. This picture helps the attackers to deploy their malicious operations, for example:In general, the attackers demonstrated great versatility, using attack methodologies best suited to a specific victim’s operational methodology. However, they seemed to deliberately limit the amount of money stolen per victim to $10 million USD. This limit may be explained as the maximum amount of money that can be transferred via mule services, or the maximum amount of money that is budgeted in banks for fraud risks in order to minimize the chances of LEAs and the bank´s anti-fraud teams from doing a full blown analysis.Sensitive bank documents have be found on the servers that were controlling Carbanak. They included classified emails, manuals, crypto keys, passwords and so on. For example, the file in the above figure has KVC (key verification codes) keys that are used by ATMs to check the integrity of the PIN numbers of its users. In other cases involving ATMs, the criminals were able to control computers that had access to the internal ATM network. If the bank had enabled remote access to ATMs, the criminals started using this access to remotely withdraw cash. Criminals used no malware to operate the ATM dispenser; instead they used standard utilities to control and test ATM equipment.Malware targeting the finance industry (both companies and consumers) continues to evolve. The Carbanak malware used in the on-going campaign described in this report has been very successful in terms of generating revenue. Of particular interest are the attack methods, similar to those used in sophisticated cyber-espionage APTs. As such, they represent a new and disturbing trend in the cybercrime market of increasing attack sophistication. Despite increased awareness of cybercrime within the financial services sector, it appears that spear phishing attacks and old exploits (for which patches have been disseminated) remain effective against larger companies. Attackers always use this minimal effort approach in order to bypass a victim´s defenses. Advanced control and fraud detection systems have been used for years by the financial services industry. However, these focus on fraudulent transactions within customer accounts. The Carbanak attackers bypassed these protections, by for example, using the industry-wide funds transfer (the SWIFT network), updating balances of account holders and using disbursement mechanisms (the ATM network). In neither of these cases did the attackers exploit a vulnerability within the service. Instead, they studied the victim´s internal procedures and pinpointed who they should impersonate locally in order to process fraudulent transactions through the aforementioned services. It is clear that the attackers were very familiar with financial services software and networks. As part of an automated reconnaissance phase, the Carbanak malware checked victim systems for the presence of specialized and specific banking software. Only after the presence of banking systems was confirmed, were victims further exploited. To date, attacks against approximately 300 IP addresses around the world have been observed on analyzed C2s. It is possible that these attacks were coordinated to maximize returns prior to industry-wide information sharing and the implementation of countermeasures. Existing telemetry indicates that the Carbanak attackers are trying to expand operations to other Baltic and Central Europe countries, the Middle East, Asia and Africa. Carbanak may be responsible for losses as high as $1 billion USD. We believe that the Carbanak campaign is a clear indicator of a new era in cybercrime in which criminals use APT techniques directly against the financial industry instead of through its customers. APTs are not only for stealing information anymore.