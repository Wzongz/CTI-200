In 2019, F-Secure uncovered technical details on Lazarus Group’s1 modus operandi during an investigation of an attack on an organisation in the cryptocurrency vertical, hereafter referred to as “the target”. The attack was linked to a wider, ongoing global phishing campaign. The detail in this report provides detection opportunities for blue teams seeking to defend their organizations from attacks by the group. Lazarus Group’s interests reportedly align with those of the government of the Democratic People's Republic of Korea (DPRK). According to a 2019 UN report 2 Lazarus Group has been targeting organizations in the cryptocurrency vertical since at least 2017. Consistent with public reporting on the group’s activities, the main objective of the attack uncovered by F-Secure was financial gain. F-Secure attributed the attack to the Lazarus Group based on similarities in malware, Tactics, Techniques & Procedures (TTPs) observed, and wider intelligence of the group’s operational practices. F-Secure’s analysis of the malware suggested strong similarities to samples leveraged in other Lazarus Group campaigns, detailed in research previously published by Kaspersky3 and ESET4. Lazarus Group was observed leveraging a combination of custom malware and native operating system (OS) utilities to reach its objective. Through the investigation it became clear that Lazarus Group invests significant time in operational security to avoid detection and remove evidence of their activity. Prior to F-Secure's investigation, Lazarus Group attempted to remove evidence of its presence on the target through the secure deletion of tooling and log data. However, some samples were retrievable, as well as some auto-captured by the target’s Endpoint Detection & Response (EDR) solution. F-Secure assess the attack on the target to be advanced in nature and was able to link this activity with a global phishing campaign running since at least January 2018. The attack was linked to this wider set of activity through several common indicators found in samples from the investigation, open source repositories, and proprietary intelligence sources. Where possible, evidence has been included in the body and appendices of this report to allow the security industry to leverage these details across their apertures, and draw their own conclusions. F-Secure believes this information will help targeted organizations protect their networks from future attacks and raise the cost of operation for the group. F-Secure’s investigation revealed that a system administrator from the target organization received a phishing document via their personal LinkedIn account. The document masqueraded as a legitimate job advert for a role in a blockchain technology company that matched the employee’s skills. Though the document on the target’s host had been altered to remove malicious content after execution, F-Secure assessed that the original document was the same, or similar to, a sample publicly available on VirusTotal5 (see image below). This was based on metadata analysis and execution evidence noted in the System Resource Usage Monitor (SRUM) database.Metadata analysis showed the document and VirusTotal sample shared identical values for the document name, author, last saved by, and word count properties. The creation time and character count were not identical, but similar enough to suggest a relationship between the two documents.However, the document’s file sizes were different—181,248 bytes vs 289,280 bytes. The Master File Table (MFT) entry for this document suggests that it could have been modified roughly thirty minutes after it was created.When reviewing the LNK (link) file on the target host relating to the document, the original file size can be seen in the “target file size” field. This file size is identical to the malicious VirusTotal sample, providing another strong link between the two documents.As can be seen in the below image, the malicious version of the document claimed to be protected by General Data Protection Regulation (GDPR) and that content needed to be enabled in Word to access the document. The enablement of content would then result in the malicious embedded macro code to execute. The malicious execution chain was then the same as noted in the JPCERT report6, where the macro in the document creates an LNK file that resulted in the execution of mshta.exe to call out to a “bit.ly” link created in early May 2019. The link was accessed 73 times from several countries, as noted in Figure 6 below. Some of these were likely researchers, however, the spike in May, and the countries with high counts, led F-Secure to assess that this was a relatively widely-targeted lure document.The “bit.ly” link redirected to a domain from which a VBScript was executed to perform checks on the host and collect further information to send to a second Command and Control (C2) domain. This script and execution chain are covered in more detail in the Weibu Intelligence Bureau report7 . In the F-Secure investigation, this eventually led to the download and execution of a PowerShell script that retrieved a further payload from a third C2 domain. Shortly after this payload was retrieved, the main implants used by Lazarus Group appeared on the target host.Once the initial chain of infection had executed, the main implant leveraged against the target was downloaded and loaded in to the lsass.exe process. Evidence of this execution was captured within the SRUM database as well as the data transferred to and from the target host (see screenshot below). Note, the entry This infection chain appeared to be highly conditional based on information retrieved from the target, and notably differs across other public reporting of the campaign. The different possible execution chains observed by F-Secure are detailed in the diagram below.F-Secure leveraged additional available data to pivot from this observed activity to further phishing artefacts, assessed to be part of a wider campaign running since at least January 2018. Artifacts identified were linked to fourteen countries, suggesting this was a wide-ranging global campaign. Those countries were: US, CN, UK, CA, DE, RU, KR, AR, SG, HK, NL, EE, JP & PH. The Indicators of Compromise (IOCs) relating to these artefacts are included in the appendices below.Lazarus Group leveraged two separate network backdoor implants that appeared similar to the “Passive Backdoor” first reported8 by Kaspersky as being used by the group in 2016. The samples F-Secure analysed were packed using Themida and despite being x64 variants, analysis showed significant code similarities with the x86 variants used in 2016. The backdoor requires a port to be entered as an argument on the command line when executed and uses the windows netsh utility to open that port in the Windows Firewall. The implant was observed operating on TCP ports 443, 3388, 3399, 5500 and 5555; example execution recorded on the target network is shown below. Despite the difference in instruction set it is possible to see the same operation was used to hide the console window and the same amount of time is defined to both wait for the operation to be completed and to sleep before continuing. These similarities can be seen in the screenshot below.The samples analysed by F-Secure also shared similarities with a “TCP Backdoor” reportedly used by Lazarus Group in a 2018 ESET report9 in attacks against casinos. When unpacked the “mmc.exe” (f8915227c25c5ac552d66f3708f615cd517363953829d3715f38666d7dfa9770) sample is identical to the unpacked version of one of the VMProtect samples in the ESET report (8b6887c5ec6fadaefee78f089e9a347a539bcedf52f5827f866a49a1839f8c4b). Figure 10 shows the same strings across the unpacked samples from the three different intrusions. As the ESET report details, the backdoor can execute a number of commands it receives via the listening port, and also stores logging and configuration information in files such as “perflog.dat” and “perflog.evt” in the ”%WINDIR%\Temp\” directory. F-Secure’s investigation uncovered “LSSC.dll” (72e0965385eae2d3a2f20feb361ce542235fe44c08991644a0a231f595039e68), a custom PE loader. The file was loaded into the lsass.exe process by masquerading as a “Security Package”10 via the “HKLM\SYSTEM\CurrentControlSet\Control\Lsa\Security Packages” registry key. F-Secure observed that Lazarus Group would modify this key locally using the reg windows utility and check this was successful via the same utility. Once this was confirmed as successful the system would be restarted in order for DLL to be loaded. Examples of these executions can be seen below. Later in the intrusion Lazarus Group was observed modifying this registry key remotely using the schtasks windows utility, as can be seen in the below snippet. The sample analysed was compiled just prior to the observed use and the internal name of the file was “xml.dll”. The file was dropped in the System32 directory, and once executed it is hardcoded to attempt to use custom PE loading code for the file “LDAP.dat”. F-Secure was unable to retrieve a copy of “LDAP.dat”, but it is believed to contain a final payload that provides Lazarus Group with the ability to execute additional commands. The main implants both contain the capability to download additional files, decompress data in memory, initiate C2 communication, execute arbitrary commands, and steal credentials from a number of sources. The implants were also observed being used to connect to the network backdoor implants on other target hosts. “LSSVC.dll” (519f100ddc98cfb9aca3e13c0095bddeadf11c50397096953171d042ca376fbd) was dropped into the System32 directory and loaded in to the lsass.exe process. Analysis indicates that this file has the capability to be loaded in multiple ways. The implant is a x64 DLL and contains the Zlib 1.2.7 and Libcurl 7.47.1 software libraries, suggesting it is capable of downloading and decompressing additional data. Once loaded, it will read and decrypt configuration information from a 6,816 byte “.sdb” file stored in “%WINDIR%\AppPatch\”. The samples F-Secure analysed were specifically looking for configuration files with the name “mscmain.sdb” or “msomain.sdb”, and were decrypted using the RC4 key “F9 5E 06 0B E3 1B 18 03 24 3F 00 CC DE AB F6 93 1B 2A CB 5B 6A C3 67 36 62 60 EC 82 46 37 D2 4A”. The implant also has the ability to encrypt and write this data to disk, allowing Lazarus Group to update this information when required. The “.sdb” file contained C2 information as well as a hardcoded target specific directory (“C:\Users\\AppData\Roaming\Microsoft\CLR\”) referencing additional malicious files. Though the “LSSVC.dll” variant of this implant does not appear to have the capability to interact further with these files. “NTUSER.cat” (831ba6efa4a49eb1c7ff749fe442b393c5a614f383bf1efb52512a183b4362fc) is another x64 DLL similar to “LSSVC.dll”. However, this variant was dropped in the “C:\Users\” directory and is not designed to be loaded into the lsass.exe process. “NTUSER.cat” uses the same software libraries as “LSSVC.dll” and also reads configuration information from the same “.sdb” files; however, this implant has the additional capability to load the referenced files from disk and inject them into another process. The files were loaded using the following steps:The copies of these additional files retrieved by F-Secure had been overwritten with random data in order to prevent further analysis.F-Secure identified several other TTPs of interest leveraged by Lazarus Group during the attack. To avoid detection, Lazarus Group disabled Windows Defender monitoring as one of their first actions on each host they accessed. This was done through the execution of the below PowerShell commands.As reported by ESET, Lazarus Group was observed using a custom version of Mimikatz to capture credentials; however, as can be seen below they have not obfuscated the commonly used functions. To enable this Lazarus Group was observed disabling Credential Guard and enabling the storage of credentials in memory via the below registry key modifications.Throughout F-Secure's investigation it became evident that Lazarus Group was conscious to avoid detection and would remove evidence of their presence, as can be seen in the below snippet.On all but a single host, which was powered off halfway through the intrusion and therefore unreachable, Lazarus Group was able to securely delete traces of any of the malware they employed as well as significant quantities of forensic evidence. The presence of a third-party EDR agent with auto-capture features for certain file types proved a valuable source of evidence preserved from this deletion. In addition, the live EDR data recorded valuable details of actions performed by the group. The execution of these commands provide significant opportunities for detection for any organisation with EDR telemetry. Whilst the goal of some of the commands are to ultimately avoid detection and remain stealthy, these actions are “noisy” in themselves and provide detection opportunities. The above provided examples of the disabling of windows security controls should be anomalous in any network, and can be used to engineer high fidelity detection use cases. Lazarus Group was observed executing a large number of commands through cmd.exe and other native OS utilities throughout their time on the target network. Despite attempts to avoid detection and blend in with standard activity on the network, elements of the commands used will often be anomalous and use specific esoteric strings that offer blue teams detection opportunities. One distinctive trait common across the majority of the commands executed by Lazarus Group was the appending of the string “2>&1” to commands; which whilst used by some tooling should be anomalous when filtered by parent child process relationship, and provide good detection opportunities. F-Secure advises organisations with Lazarus Group in their threat profile to develop good coverage of these native OS techniques to maximise detection opportunities. These commands can blend in with standard activity, so it may not be possible to build high fidelity detection for all the techniques used. In this situation the use of lower fidelity detections that are then aggregated on a host basis in order to correlate activity and build intelligent thresholding in to alerting systems can help to detect malicious activity without generating too many false positives. The custom PE loader and one variant of the main implant were both loaded in to the lsass.exe process as unsigned DLLs, which is a high-fidelity indicator for anyone monitoring these module load events. The addition of the registry key to load these files is also a high-fidelity indicator that could be detected through the command line execution or registry scanning for the creation of keys in this path. There were a number of files created on disk by Lazarus Group, with notably “perflog.dat” and “perflog.evt” having been created in the “%WINDIR%\Temp\” directory and observed across previous campaigns. In addition, analysis of the main implants indicates they create the file “mscmain.sdb” or “msomain.sdb” in the “%WINDIR%\AppPatch\” directory. In both cases the files appear to be uniquely used by this group; therefore, provide a high fidelity indicator that can be used for detection and potential attribution. Beyond host level detection there are also significant opportunities to detect the network layer activity of the various implants, which were using anomalous ports to communicate between workstations and servers that would stand out from standard traffic. The target organisation had an artificial intelligence based network detection security tool installed, unfortunately this did not raise any alerts generated during this time period. The tool was a useful source for evidence during the investigation and the telemetry collected did contain actionable detection data that blue teams could leverage for proactive means. Lazarus Group has demonstrated sophistication and operational security awareness in executing a prolonged and ostensibly successful cybercrime campaign. The success of this campaign is evidenced in a recent announcement by the US Treasury11 relating to money laundering of the profits of Lazarus Group. The findings of F-Secure’s investigation are consistent with the strategic intelligence picture, but provide more detail on the group’s current tactics, techniques and procedures. Lazarus Group’s activities are a continued threat: the phishing campaign associated with this attack has been observed continuing into 2020, raising the need for awareness and ongoing vigilance amongst organisations operating in the targeted verticals. It is F-Secure’s assessment that the group will continue to target organisations within the cryptocurrency vertical while it remains such a profitable pursuit, but may also expand to target supply chain elements of the vertical to increase returns and longevity of the campaign. In addition, some of the newer C2 infrastructure suggests the group may be looking to target organisations in the financial investment vertical. It is also F-Secure’s assessment that organisations in other verticals likely to be targeted by elements of DPRK cyber operations should take note of the details contained within this report. There is evidence in recent reporting12 of Lazarus Group leveraging similar techniques to those observed in this campaign, such as the preference of LinkedIn as a delivery medium, to compromise organisations in other verticals. This is also supported by the evidence that Lazarus Group has re-used tooling across multiple campaigns, as noted previously in this report. Lazarus Group has continued to use some of the same family of tooling observed in 2016, though analysis of several samples suggest this is being updated over time. It is F-Secure’s assessment that the investment in both malware anti-analysis techniques and operational security to remove evidence of their presence has preserved the operationally effectiveness of this tooling for Lazarus Group. It is also possible that the group lack the capability to easily retool and therefore are reliant on maximising the utility of the existing tooling at their disposal. However, other tooling has been publicly attributed to the group which suggests further capability can be leveraged if required due to target controls. F-Secure found that the activities performed by Lazarus Group, whilst effective, offered significant opportunities for detection. Organisations targeted by Lazarus Group should review their detection capability, with regards to both technology and people, against the techniques noted in this report and those in the MITRE ATT&CK framework13 attributed to the Lazarus Group. The target in this investigation had a leading EDR and network security tool installed that captured telemetry of Lazarus Groups actions, but this did not result in a positive detection that was actioned. It is F-Secure’s view that people play an important role in building effective detection capability, and this incident serves as an example of the need to invest in people as well as technology.