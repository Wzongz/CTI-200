The incident response team of HvS-Consulting AG was recently involved in coordination, analysis, and remediation of multiple Advanced Persistent Threats (APT) against different European customers operating in the manufacturing and electrical industry. During incident response it turned out that industries and products of the affected companies are related to each other and the observed Tactics, Techniques & Procedures (TTPs) and Indicators of Compromise (IOCs) can be attributed with high confidence to the APT group Lazarus. In handling multiple Lazarus incidents in parallel, we have been able to accumulate further details of the threat actor’s behavior and the toolset of later phases of the Mitre Att&ck framework. These details, which are described in this document, provide a comprehensive picture of the 2020 Lazarus campaign, extending existing reports with observed TTPs. Based on the unveiled and observed TTPs it seems that the attacker’s objective is exfiltration of very selected information.Based on the gained technical IOCs and derived TTPs from the different engagements, we assess with high confidence that those incidents were caused by the threat actor Lazarus/APT37. When comparing those IOCs with TTPs from public and private reports about the Lazarus Group, we detected huge overlaps, e.g., in re-use of command and control infrastructure as well as observed process commands and tools. German authorities share this assumption, too. The Lazarus Group1 , also named G0032 by Mitre, and more specifically to the subgroup APT37 or G0067 is considered to belong to the North Korean government.Due to the number of analyzed incidents, HvS had the chance to compare the timelines and to draw conclusions. The results are shown in Figure 1, which contains the timelines of four different incidents. Please note, that the exact dates are shifted a bit to guarantee anonymity, nevertheless the flow of actions remains unchanged. Between July 2019 and March 2020 there were only a few publications by security researchers about detected activities and new indicators from Lazarus, which now can be translated in “the calm before the storm”. Apparently, the group was busy in preparing a new campaign.Interviews with various patient zero users of the incidents revealed that they all became victims of social engineering attacks. All of them were contacted via LinkedIn in the second half of February 2020. Only one victim in Asia directly received a malicious document. Although that client was compromised early, attackers did not use the C2 channel immediately. In all other cases the attackers started individual conversations with the victims to build up confidence and trust. They later abused this trust to persuade victims into executing malicious documents on their system.For incident #2, there is only a rough timeline available, but the actor had been active in May and was contained end of May. Within three days at the end of May, attackers delivered malicious documents and thus compromised the victim’s devices of incidents #3 and #4. Further, they started to actively use the C2 channel in incident #1. As in incident #1, they waited to use the C2 channel of incident #4.In incident #3 attackers used the established access immediately for internal reconnaissance and shortly after for lateral movement to gain a better foothold. Subsequently, they searched for interesting information within the network and performed further lateral movement, until the incident was successfully contained end of June.Only three days after containment of incident #3 - which even included a weekend - the attackers started internal reconnaissance and lateral movement in incident #4. For some reason, the C2 channel used in incident #4 broke in the beginning of July and the actor lost access. Thus, they started over with social engineering against a victim on another continent and regained access to the network in mid of July. This quick execution of a “Plan B” shows that the attackers have been well prepared and did their research about the target organizations and selection of victims early in 2020. Incident #1 was kind of special. Apparently, it was harder to gain foothold in incident #1 due to the more restrictive network design. Hence, multiple lateral movement attempts from patient zero in Asia towards Europe were successfully contained by the victim, until patient zero was identified end of July. After regaining access on another continent, the attackers also re-accessed previously compromised systems from incident #4. Then they started internal reconnaissance, clearly intensified lateral movement, and searched for interesting information, until in mid of August incident #4 was also successfully contained.During that containment, one compromised client was isolated and kept running to monitor further activities. We discovered that the attackers verified the C2 connectivity monthly and renewed parts of the malware.In November 2020, the attackers compromised a European subsidiary of the victim of incident #1 and started lateral movement again. Interestingly we made the same observation as in incident #4, that the TTPs have changed after reinfection. To achieve better persistence local accounts were created as described in 2.2 and for lateral movement instead of Windows Management Instrumentation. Windows Services were used as shown in 2.7. While in the first stage the compromise of systems was limited, after reinfection a clearly higher number of systems were compromised. Nevertheless, in both incidents, the attackers accessed previously compromised systems after their successful reinfection and reused already compromised accounts. During the time of writing, spearphishing mails with job opportunities were still distributed to employees of the victims, like shown in Figure 2.While in the four described incidents attacker’s activity took place from May to August 2020, there is proof for further activity.The analysis of the four incidents clearly shows that those actions are part of a very targeted and planned campaign. This campaign has access to vast resources, e.g., a complex C2 and data exfiltration infrastructure consisting of various compromised websites. Comparing the described activities of the Lazarus Group to various other analyzed incidents of groups like Chafer, Winnti or OceanLotus, it attracted our attention that Lazarus made less mistakes. They performed the attacks straight forward with a clear objective and cleaned up their traces cautiously. The observed toolset is very flexible, can replace C2 infrastructure on the fly and runs completely in memory. Furthermore, the group showed mature capabilities for tunneling traffic and overjumping “air gaps”, respectively internet isolation of systems and networks. The main lessons learned are：Following the most important observed techniques, tools and practices and considerations which led to IOCs given in chapter 3 are explained and mapped to the Mitre ATT&CK framework.The threat actor obtained initial access in each of the compromised networks with the already described approach of social engineering and spearphishing attachments. Therefore, fake LinkedIn profiles for HR managers of well-known companies (e.g., Boeing or General Dynamics Land Systems) were created. The profiles looked genuine at first sight and even an online search for the profile names revealed real HR employees. First contact to obviously carefully selected victims – the number of known victims is the necessary minimum per incident – was established at the end of February until mid of March 2020. After introducing as HR manager with potential job opportunities, casual conversation took place, which at least in one case switched over to WhatsApp after some time. End of May 2020 malicious Word documents were sent to the victims in Europe with different approaches, pretending to be a job description for a lucrative position at Boeing. The attachment makes use of different malicious Word documents or ISO files consisting of a decoy PDF bundled with a modified PDF viewer program. The documents download and persist a malicious DLL in the system. Further, the threat actor is extremely persuasive as well as sustained. In one case, the victim attempted to open a malicious Word document on his private notebook, which had only OpenOffice installed. As reaction to his feedback that the file is not displayed correctly, the threat actor suggested to send the file to his company mail to open it with Microsoft Word. However, the attachment was blocked by an mail security platform. Therefore, the threat actor shared a decoy BoeingPDF.iso via WhatsApp and asked the victim to transfer the file from his cellphone via USB tethering to his company notebook. Furthermore, the attackers explained the victim step by step how to mount the ISO file and how to execute the contained exe file. To keep the story alive, the victim was contacted again after about one month with another job offer For persistence two different DLL downloader variants were found: Variant a) used DLLs, which were manipulated versions of well-known DLLs like OpenSSL’s libeay32.dll or SQLite’s sqlite3.dll. This technique seems to be used more common as other researchers described it also . For invocation, an original named PE export together with an encryption-key parameter is called, e.g. The threat actors code is persisted via a harmless looking Windows lnk file (e.g. OneNote.lnk) in the Startup folder (%APPDATA%\Microsoft\Windows\Start Menu\Programs\Startup) of the compromised user account. This tactic is also described by ClearSky Cyber Security and McAfee in their respective reports. It is assumed that all downloaders retrieve an encrypted version of the BLINDINGCAN / DRATzarus RAT. On two systems it was identified that the threat actor directly persisted malicious executables, which likely are the final stage of the BLINDINGCAN / DRATzarus RAT. The executables were very large (~ 65 MB), in both instances invoked with the parameter -p 0x57AC098B and persisted in the compromised user’s run-key. The parameter -p together with the hex values 0x57AC098B or 0x53A4C60B was frequently observed in the threat actor’s process executions (see listing below). However, intact versions of these executables have not been obtained.In one incident the threat actor created local administrative accounts named admin$ to hide them from the net user command output. The accounts were created remotely via the Windows sc command. The string abcd1234!@#$ was used as password. Such patterns where seen commonly for attacker passwords. As described in chapter 1.3, TTPs changed after reinfection, this technique was only observed in the second attempts.n one case the threat actor used an Eternal Blue exploit (MS17-010, the vulnerability allowing the WannaCry breakout) to perform a privilege escalation on a remote Windows server. The exploit execution was invoked with the following command:Although, it was not possible to recover a sample of the exploit (only its SHA-1 hash is known from the AmCache hive: f09d9c7783adb4a44d48c77e412319e1c9cd4384), a text output file SearchProtocols.out was recovered from a Volume Shadow Copy:The exploit creates the local user tempAdmins in case of success with administrative permissions and the password 1q2w3e4r5t!@#$. The threat actor deleted his tools, text output and exfiltration files etc. with the Windows del command. Due to the delay between the threat actor’s activity and subsequent detection and analysis of the incident, this simple deletion was sufficient to remove most artifacts from the file system. As in some cases deletion took place on the next working day, some artifacts could be retrieved from nightly server backups.The attacker’s remote access trojans and staging tools are protected against automatic sandbox analysis via encryption and require its encryption keys as a parameter. However, also the execution with the correct parameters but without internet in a virtualized sandbox machine did usually not produce valuable results. It was not further analyzed whether an execution on bare-metal or with internet would give more insights.For credential dumping the threat actor used a custom encrypted Mimikatz which is decrypted in-memory via a small loader executable. The execution did use the following command line call:As the threat actor failed on one occasion to delete the tool and the output files, the following information was identified: The ~DF012.TMP file is a small loader program comprising 61 KB, which decrypts and loads Mimikatz from the ~DF011.DAT file. The file ~DF011.TXT corresponds to the default output of the sekurlsa::logonPasswords command. The string 1q2w3e4r@#$@#$@#$ is the required encryption key. The key may also be shortened to the string 1q2w, Mimikatz does still execute correctly. Another Mimikatz variant was identified in the command line of an unknown binary, with a double Base64 encoded string as a parameter. Decoded, the string corresponds to the well-known Mimikatz command:In addition, the usage of renamed executables of the SysInternals tool procdump was discovered. The threat actor systematically analyzed home directories of admins, software configuration files, and setup / maintenance scripts to identify valid credentials of existing domain accounts. For instance, the following commands were executed:The tool AdFind, renamed to C:\ProgramData\IBM\IBM.dat or C:\ProgramData\Kagent.exe and UPX packed, was used to enumerate all organizational units, users, computer, and groups of the victims Active Directory:The threat actor used a threaded SMB scanner to enumerate shares and to test local administrative permissions with previously harvested credentials. The binary is internally dubbed “Scan.exe” and accepts following parameters:While StartIP and EndIP are expected to be Ipv4, a numeric thread count, a full path for the output logfile and optional a user and a password is given. Following exemplary execution by the threat actor was identified:The Windows Admin Shares were the threat actor’s primary technique for lateral movement. Frequent modus operandi were following actions: The attackers used WinRar to pack data into encrypted archives. Often archiving was directly performed on the system holding the data itself. After the packing procedure, the archive was copied to a compromised client and then exfiltrated from there.Prior to the collection of data and the packing with WinRAR, the attackers used dir-listings to determine the content of folders on the local systems as well as shares which were accessible from the current host. After the exfiltration of the dir listings and some time for review, only specific files which seemed of value were collected.It must be noticed that also data of administrators and IT departments was targeted. It is assumed that the objective was to learn more about the internal network and the internal infrastructure. This information was probably used to plan and prepare their lateral movement and to locate the valuable information. In summary, these procedures show that the goal of the attackers was not to exfiltrate data in bulk, but rather searching for specific information. Besides the Windows command dir, process executions of their RAT component with the following pattern were identified:Based on file fragments it is assumed that this command creates a recursive directory listing of the provided path.The attacker’s procedure for hosting their C2 servers is compromising legit websites via publicly known vulnerabilities and then adding their C2 endpoints on these webservers without interfering with the usual behavior of the legit website. The communication is then performed via HTTP and HTTPS. Different stages make use of different webservers and endpoints. For example:The threat actor most certainly uses public exploits to compromise these third-party webservers. For example, the C2s 137.74.114.227, bootcamp-coders.cnm.edu and yakufreshperu.com had an old version of the Lavarel PHP framework installed. All three were vulnerable to CVE-2018-15133 a deserialization vulnerability that allows Remote Code Execution. In order, to control the webserver the threat actor dropped a b374k webshell named bnotices.php with an unknown password.For the exfiltration of data, the attackers also used legit websites which have been compromised in advance. The upload of the data from the victim network to the websites was performed via HTTP and HTTPS. From there, the Tor network was used to access the uploaded data and to download the data. After retrieving the exfiltrated data, the files were deleted from the webserver. The following command was used to upload the Rar splits:The program ~DF234.TMP has not been recovered. However, most parameters can be derived from previously known details. The parameter C:\ProgramData\IBM\restore0031.dat is the Rar split stored on the compromised system. The IP 192.168.1.240 and the number 8080 denotes the company’s proxy and its port. As the recovered webshell thumb.asp receives a file name as a POST parameter it is assumed that data03 is the name of the archive on the webserver. The following figure provides a high-level overview of the traffic flow between compromised companies and the attacker infrastructure user for data exfiltration:By analyzing the access logs from the provider, which hosted one of the compromised web sites, three victims could be identified, which were communicating with the C2 infrastructure of Lazarus. The access logs showed that from these three victims the ASP files, which were used for dropping files onto the storage of the web server, were accessed roughly 15,000 times. The exfiltrated files were uploaded as encrypted rar archives as described in Section 2.8. To complete the exfiltration of the data, the attackers accessed another ASP file via Tor, which was used for downloading the previously uploaded Rar archives. Since Tor was used, there is no way of tracing back the accesses to its origin. After retrieving the exfiltrated data, the help.asp file was accessed via Tor to delete the files on the webserver. Furthermore, the web hoster provided the samples of the ASP files. Each file was analyzed to determine its purpose. The samples thumb.asp, thumbs.asp, and img.asp are identical, based on their hashes. The source code of the file is shown in Listing 11. The code simply extracts the post parameters fr (filename) and fp (filedata) from the POST request and writes the file data to the workdir, which is created based on the current URL appended by the string “video”. If the upload has been successful, the string “S:“ is displayed on the website together with the size of the data which has been written to disk. If the file write procedure fails, the string “E : F” is returned. No direct impact of the attackers could be observed. This fact supports the assumption that the only objective was the gathering of valuable data and their successful exfiltration. Beyond that, the attackers had no interest in further impacting the victims. In most cases, it appears that also the amount of compromised assets is at the required minimum level to operate smoothly and keep the C2 traffic alive. Servers were only compromised as far as necessary, mostly only files were collected. In case of lost C2 connectivity broader lateral movement and compromise of systems was observed after reinfection. For better accessibility we published the following IOCs on our GitHub repository: https://github.com/hvsconsulting/ioc_signatures Note that the threat actor hardly reused binaries with identical hashes across different machines. Therefore, the focus in incident detection should be C2 addresses, process execution command lines and used file name schemas.