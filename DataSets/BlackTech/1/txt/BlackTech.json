claim：NTT Security Holdings Corporation Japan Security Operation Center has been monitoring active attacks from APT group BlackTech, and this report covers the following topics on the attacks based on our research
explain：NTT Security Holdings Corporation Japan Security Operation Center provides Managed Security Service (MSS). We monitor our client systems round-theclock, find security incidents promptly and provide best solutions. We perform various research on latest threats and output the achievements as black lists, custom signatures and Indicators of Compromise (IoCs). These knowledges are also used by our SOC analysts. Our SOC has been monitoring attacks by one of well-known APT groups, BlackTech. Though many organizations have been reported the malware used by BlackTech, our SOC publishes this whitepaper discussing the latest attacks by BlackTech based on the actual attacks we monitored in 2021. We expect that this whitepaper contributes to better defense against attacks from BlackTech. NTT Security Holdings Corporation Japan Security Operation Center has been monitoring active attacks from APT group BlackTech. This report covers the following topics on the attacks based on our research.Appendix contains the list of hash values that we obtained during our research. This would help to prevent infection or isolate the victims.It is known that APT group BlackTech (also called as Palmerworm, Red Djinn, Earth Hundun or HUAPI) had started their activity at the latest 2012. They have been targeting organizations based in Eastern Asia, especially in Taiwan and Japan. Their main objective seems to steal sensitive information from target organizations. BlackTech utilizes various malware families. Some of them are publicly available (Bifrose or Gh0st RAT) and others are self-developed (TSCookie or PLEAD). They have kept developing new malwares, which means that they are actively working. Our SOC has observed attacks by BlackTech, but the number of attacks rapidly increased around 2020. Our SOC has observed they repeatedly attacked several organizations in telecommunication, defense and mass media industries. In many cases, they established their initial foothold in overseas branch office of Japanese companies, then intruded into mission critical system in headquarters. It is highly probable that BlackTech keep targeting Japanese companies, therefore implementing proper countermeasures both in remote office and headquarters is required to protect from their attacks. This whitepaper reviews and summarizes the BlackTech's attack campaigns and malware targeting Japanese organizations that our SOC observed in 2021. We hope that this content will help considering and implementing effective countermeasures to protect each organization. Origins of BlackTech attacks targeting Japanese organizations are almost either of below. Most of the attacks we observed started with spear phishing. An attacker sends an email pretended to be sent from a business partner to a user. As soon as opening the attached file, the user is infected by malware. The mail body and attached file are so sophisticated that it is difficult for the user to feel odd at a glance. Our SOC has observed attacks that leveraged real internal document used in the target organization in the past. The attached file was either an executable file with double file extension or Microsoft Excel file in xlsm format. These files can be contained in an archive file including RAR format. The archive file is password-protected, and the password is included in the mail body. Our SOC had observed several xlsm files (also called as LAMICE [1]) and macros embedded on them were very similar. This suggests that all of these files were created by single tool. Interestingly, it is observed that APT group Blackgear had used very similar macro during their attacks. This implies that the tool that generate this macro could be shared among multiple APT groups or BlackTech and Blackgear are closely related. BlackTech has been abused various vulnerabilities in their attacks. According to the blog article by JPCERT/CC [2], there were many tools that can exploit various vulnerabilities on C&C server operated by BlackTech. It is also reported [3][4][5] that they had actually abused vulnerabilities on Microsoft Exchange Server. Successful exploitation results in malware execution. Using the malware, the attacker collects environmental information, repeats lateral movement, and go deeper into the target organization. It is also observed that they use certain malware family on different platforms. For example, they use ELF Bifrose on Linux environment and PE Bifrose on Windows environment. BlackTech utilize various malware families. The figure below summarizes the malware families that they use by attacking vectors. Flagpro is malware used in initial phases of an attack to investigate a target environment and download and execute further malware [6][7]. Flagpro (v1.0) may have been used in attacks of October 2020, and the new Flagpro (v2.0) using the MFC (Microsoft Foundation Class) library may have been used after July 2021. Flagpro uses IWebBrowser2 interface and other interfaces from Internet Explorer’s COM object to handle access to and from a C&C server. Flagpro automatically closes dialogs, which appear when accessing external sites, such as proxy authentication confirmation dialogs. We assume that the auto-close function was implemented to keep users from realizing that Flagpro has accessed an external site.Flagpro is obfuscated by inserting dummy code repeatedly. The obfuscation technique is often implemented in the malware used by BlackTech.Control commands received from C&C server are encoded in Base64. Decoded commands used in Flagpro (v2.0) have the following format.The Download Command format is shown in Figure 6, and consists of the string “Exec”, “Yes”, and the URL path to the download site. The string “Exec” is an activity flag, which must be present in both Download Command 1 and 2 in Figure 5 for the main process such as downloading and executing OS commands to take place. The string "Yes" is the execution flag; without it, the downloaded file will not be executed. Flagpro uses HTTP protocol to communicate with C&C server. As shown in Table 1, it switches the URL path for each communication purpose. In addition, when this malware sends the results of OS commands execution and collected authentication information, the contents are encoded in Base64 format and sent to the C&C server as URL parameter values.SelfMake Service is a loader that loads and executes malware on the infected hosts. It is designed to run as Windows Service. Besides, according to the article [5], this loader executes SelfMake Loader described on the next section. Some samples of SelfMake Service not only load and execute malware, but also kill the legitimate splwow64.exe process and execute malicious splwow64.exe that has been overwritten with the malware on the infected host. The splwow64.exe is a file used by PrintSpooler, a Windows Service related to printing. SelfMake Loader is malware that loads and execute other malware [1][3]. It has been reported that this malware executed Spider RAT. The name of SelfMake Loader is derived from the strings “selfmake2” or “selfmake3” in the malware samples. One of the features is that this malware uses MFC (Microsoft Foundation Class). SelfMake Loader can be divided into two types based on the method of loading malware. The first type is to load and execute malware located on the infected host. The loader searches the following directories in order and executes the first malware it found. The other type is to download the malware from a C&C server to the %TEMP%directory and execute the downloaded file. The file also includes an XOR encoded configuration. This configuration is a pipe-delimited format and contains domain and port number of the C&C server. The configuration format is similar to Bifrose malware which BlackTech uses. This pipe-delimited configuration is a common characteristic of BlackTech's malware.The following figure shows a file format that SelfMake Loader loads from the infected host. The file which is downloaded from the C&C server is in a similar format. The malware is XOR encoded and is decoded by a key contained in the file.In addition, based on the code similarities, we consider that the code of executing the decoded data is used the one published on GitHub [8]. SelfMake Loader calls the following function several times. The following function simply output a string using the printf function; that is to say, this is a dummy code. BlackTech tends to utilize malware that contain such dummy code.HeavyROT Loader is a loader that downloads malware from a C&C server and executes it. There is a sample of this loader which downloads malware from the same C&C server as SelfMake Loader and it would indicate the sample relates to BlackTech. We named this malware HeavyROT Loader since it uses bit rotation calculation for RC6 cryptographic algorithm or calculation of checksums, as will be described later. The malware communicates with C&C servers using HTTP, and Basic authentication is implemented to the servers. The malware communicates with the servers again with the flag enabled which ignores a certification error (ERROR_INTERNET_INVALID_CA) in case this error occurs in HTTPS communication. In addition, the malware gets the User Agent string from an infected machine’s registry in order to set the string to an HTTP header. The downloaded data from C&C servers contains encrypted PE data as well as a seed for generating a decryption key. Furthermore, the malware calculates the checksum before and after decrypting PE data and it halts processing if the checksum does not match the downloaded data. The following figure shows how the malware generates a key for decryption from a seed. It is notable that the malware extracts original PE file by using RC6 encryption (not decryption) routine after generating the key. Although there was no theoretical evidence, we confirmed that the data encrypted by RC6 decryption routine can be decrypted by RC6 encryption routine. We assume that the data downloaded from a C&C server contained the encrypted data by RC6 decryption routine, and the malware decrypted original PE file by RC6 encryption routine to the encrypted data.AresPYDoor is backdoor malware. It is said to be related to BlackTech, because the C&C server used by AresPYDoor has relation to it used by Bifrose, also BlackTech malware [17]. AresPYDoor is based on a Python RAT [9] released on Github under the name Ares and is converted to an executable file. AresPYDoor uses the URL format shown in Figure 18 to access the C&C server and receive commands.One of the characteristics of AresPYDoor is its multi-platform support. There are several codes implemented to work on both Windows and Linux. As an example, Figure 20 shows some of the persistence codes.Spider RAT is a RAT [1][4] executed by LAMICE or SelfMake Loader. There are 32-bit and 64-bit samples. Although they have some similarities, these functions implemented in each sample are different. In this section, we will start with 32bit sample and continue with 64bit sample. We observed that there are two executable files (DLL files) embedded in the .data section, one of which will later be edited and dropped in the persistent phase. The behavior of these DLL files is to execute “C:\Windows\System32\calc.exe". Although there are two embedded DLL files, they have the same behavior.The characteristic strings, shown in Figure 24, can be seen in the debug output. Such strings are also seen in 64-bit samples. Three persistent behaviors described below can be specified depending on the value of PERSISTENCE in the configuration. In this case, the sample was set not to run these persistent behaviors.Control commands implemented in Spider RAT 32-bit sample are shown in Table 3. The pair of offset values 0x4 and 0x8 in the received data determine each command.We also observed 64-bit samples, and their implementation is simple compared with 32-bit sample. The 64-bit samples use multi-threads approach for processing. However, we have confirmed that some threads have no processing content. We assume that some features will be implemented in the future. The configuration of 64-bit samples do not have specific structure like 32-bit one, but information such as C&C server is hard-coded. In addition, there are some characteristic strings that are also found in 32-bit in the debug output. Control commands implemented in 64-bit Spider RAT are shown in Table 4. The pair of offset values 0x4 and 0x8 in the received data determine each command.BTSDoor is backdoor malware [6]. It has been observed that Flagpro downloaded and executed this backdoor. The name of BTSDoor is derived from the pdb pathname BTSWindows. BTSDoor implements the following commands. The traffic is encrypted with AES as is the case with sending information about the infected host.Gh0stTimes is customized based on the leaked Gh0st RAT source code and has been used in some attack cases since early 2020 [2].Gh0stTimes adds the feature to communicate with the C&C server by implementing the new CPortmapManager and CUltraPortmapManager classes. In addition, Gh0stTimes implements features such as file operations (CFileManager class) and remote shell execution (CShellManager class) that are reused from Gh0stRAT. Gh0stTimes repeatedly inserts dummy code to make analysis difficult. BlackTech frequently uses this type of obfuscation technique.Gh0stTimes equips control commands for each function, such as file operation and remote shell execution [2]. Additionally, this malware supports some specific commands for file operations. Gh0stTimes uses a proprietary TCP protocol to communicate with the C&C server. At the beginning of its communication to the C&C server, Gh0stTimes sends an authentication ID and data for generating encryption key. If the authentication ID is not correct, authentication fails. The encryption key is generated by processing the data sent from the victim host, which is provided at the beginning of the communication. Afterward, Gh0stTimes sends/receives control commands that are encrypted with custom RC4 algorithm (RC4 + XOR 0xAC) and compressed with zlib. TSCookie is a downloader that downloads TSCookie Loader and TSCookie RAT [11]. The downloaded files are encoded. Therefore, TSCookie decodes them after loading them on memory, then it executes them. It exists two versions of TSCookie, Windows and ELF binary version. This section describes a Windows version, and the next section explains an ELF binary version. The behaviors of TSCookie Loader and TSCookie RAT can be checked in JPCERT/CC blog posts [10][11].Executing TSCookie leads to load RC4-encrypted data on memory. The data exists in the resource section of TSCookie. Afterwards, it will be decrypted as a DLL file. The decrypted DLL contains dummy codes like other BlackTech’s malware.After executing the decrypted DLL, it will connect to a C&C server. The configuration, which includes destinations of C&C server, is hard-coded in the sample, and its structure is almost the same as the samples reported by JPCERT/CC [11].TSCookie connects to the C&C server using HTTP GET method to download a TSCookie Loader. When TSCookie downloads TSCookie Loader, it will send RC4 encrypted data to the C&C server. JPCERT/CC reported that their samples inserted the encrypted data into the Cookie header [11]. Whereas, our sample inserted the data into the URL path.URL path is replaced by swprintf() based on format string. TSCookie splits the encrypted data into two parts, and the split position is decided by random number. The URL path of HTTP GET request is as follows: The structure of the original data, which means the sending data before encryption, has been changed since the existing report from JPCERT/CC [11] as follows:This download activity will not execute if the first four bytes of the response data do not match to the hard-coded value in the sample. After downloading TSCookie Loader, TSCookie downloads its modules. HTTP POST method is used for downloading the modules. TSCookie inserts the RC4 encrypted data into the BODY part. The Date header value is used as the RC4 key.This POST request also works as heartbeat and is sent around every 50 seconds. However, if the first four bytes of the response does not match to the hard-coded value in the sample, the POST request will not be sent from the next request. This section explains ELF version of TSCookie (ELF_TSCookie) [14]. ELF_TSCookie contains same functions as Windows version. However, the functions are limited. The samples, which we found, target not only Linux environment users, but also FreeBSD ones. We assume that the attacker uses the different version of TSCookie depending on the target's environment. The command values of our samples have changed from the values reported by JPCERT/CC [12]. This JPCERT/CC report provides the detailed analysis result of the past samples. The “file” command result shows that it is static-linked file, and the “readelf” command result indicates that this malware could be compiled in old development environment. It seems that attackers would like to evade environmental problems. As JPCERT/CC has already reported [12] that information about C&C servers is inserted as plain text. ELF_TSCookie copies the information onto allocated memory space and encrypts it with RC4. The encrypted information will be used in later process.ELF_TSCookie sends the host information to the C&C servers. The information contains TSCookie PID, IP address, hostname, and login username. The code to obtain the host information is shown in Figure 38. It may be intended to get the result of “uname” command, but it has a wrong option “- a00”. Hence the command will be failed, and the result will not be sent. ELF_TScookie commands are listed in Table 9. No major changes of the commands have been observed since JPCERT/CC had published its analysis result [12].IamDown is a malware that downloads and executes another malware. It has been used since at least 2014. We call this malware “IamDown” because the string “i am mutex!” is inserted into this malware and this is a downloader malware.The hard-coded strings such as “i am mutex!”, the C&C server domains, and a Mutex value are embedded in IamDown. We assume that this malware has some relationships between Poison Ivy, because the Mutex value of IamDown ”)!VoqA” is same as the head of the default Mutex value of Poison Ivy ”)!VoqA.I4” [13]. IamDown uses Socket for communicating with the C&C server with TCP/443 port. The first 16 bytes data is the fixed valueIamDown sequentially checks the received data from head. If the data matches the condition, Socket will close, and if not, the data procedure will continue as shown in Figure 41. IamDown executes the downloaded data on a new thread in the same process. This means that the data is not stored as a file on the infected host.We will explain about ELF version of Bifrose (ELF_Bifrose). Our sample does not exist big differences from the past reported samples [14].The results of “file” and “readelf” commands is shown in Figure 44. The samples were compiled in an old environment and statically linked. It seems that attackers would like to evade environmental problems.An example of the first sending data is shown in Figure 47. ELF_Bifrose communicates with port 80,443, and 8080, but it uses Socket connection rather than the HTTP(S) protocol. After sending the data, ELF_Bifrose receives commands from the C&C server. The implemented commands are in Table 10. The commands have not been changed significantly from the existing samples [14].We will explain about ELF version of PLEAD (ELF_PLEAD). JPCERT/CC reported the detailed analysis result about the existing samples [16]. However, we will show the analysis result of newly observed samples in this report.The results of “file” and “readelf” command are shown in Figure 48. The samples were compiled in an old environment and statically linked. It seems that attackers would like to evade environmental problems.ELF_PLEAD encrypts configuration with RC4 as existing samples does. Figure 49 shows an example of the decrypted configuration. The first 32 bytes data in the Figure 49 is the RC4 key, and after the key follows the configuration. The configuration size is 0x1AA. As the following configuration indicates that a private IP address is set as the destination. In addition, the uncommon destination port 29678 is configured. From these settings, we assume that this configuration was adapted to the targeted company that had already been intruded. BlackTech has two main attack vectors. The first is an attack method originates from spear phishing emails. The second is an attack method exploits server vulnerabilities. The best way to defend against spear phishing emails is to avoid opening suspicious emails, links or files. BlackTech attacks with emails and attachments that are spoofed as if they were clients of the target. It is possible to prevent the attack by carefully checking the sender email address, the text of emails, and the double extensions of attachments. In addition, the installation of email security products is also an effective measure. Our SOC has observed that these products have detected spear phishing emails by BlackTech. To defend against exploitation of server vulnerabilities, we recommend that applying the latest update programs or the latest security patches. Furthermore, the installation and the properly operation of network security products and endpoint security products are also effective measure. Even if your organization were initially accessed by such threat actor, these products will detect later behaviors. Our SOC has created custom signatures to detect such behaviors, and in some cases, we have been able to minimize the damage by detecting and quarantining them. Although BlackTech is actively developing new malware, its attack techniques have not changed much. Thus, it is important to build detection logics against them. In both attack vectors as we mentioned, BlackTech targets vulnerable areas of the target organization. In particular, overseas offices tend to be attacked by BlackTech. Even if your organization’s critical infrastructure is managed in a closed network, BlackTech will examine all possible paths to penetrate it, identify where are vulnerable areas, and attempt to compromise them. Hence, proper management of your organization’s systems is important. Furthermore, BlackTech is known to repeatedly attack against the same targeted organization. Even if BlackTech intruded once, or even if intrusions were prevented, your organization’s systems still have risk to be attacked over and over. We recommend keeping up with the latest attack trends and taking measures properly and quickly. NTT Security Holdings Corporation Japan Security Operation Center has conducted research activities for the prevention of security incidents and early detection when they occur. In particular, we have actively investigated and analyzed on targeted attacks for clue to consider countermeasures against further sophisticated attack. In this report, we provided a walkthrough of BlackTech’s activities based on the cases we observed in 2021. BlackTech has extremely actively attacked against Japanese organizations repeatedly, and it can be continued. Our SOC will continue to research BlackTech. IoCs are listed in the Appendix. We hope you will find it useful.
[
    {
	link：https://blogs.jpcert.or.jp/en/2021/10/gh0sttimes.html
        "report_id": "report_0",
        "sentences": [
            "By the hardcoded product name, we infer that the attackers are knowledgeable of the victims’ environment and which security product(s) they use.",
            "In our analysis, we have discovered that the security vendor is APAC-based, which is consistent with BlackTech’s targeted countries.",
            "It is associated with the cyberespionage group BlackTech, which mainly targets technology companies and government agencies in East Asia (specifically Taiwan, and in some instances, Japan and Hong Kong) and is responsible for some infamous campaigns such as PLEAD and Shrouded Crossbow.",
            "It is possible that this check is designed according to the nature of the security product it targets.",
            "The attackers might also be familiar with how security products gather information on their clients’ endpoints and networks, so that they know which APIs to hook.",
            "The purpose of this is to further avoid being detected by a certain cybersecurity solution."
        ]
    },
    {
	link：https://symantec-enterprise-blogs.security.com/blogs/threat-intelligence/palmerworm-blacktech-espionage-apt
        "report_id": "report_1",
        "sentences": [
            "It stands in a class of its own in terms of being one of the most sophisticated, well-engineered and difficult-to-detect samples of shellcode employed by an Advanced Persistent Threat (APT).",
            "It was discovered absent additional information regarding the exploit vector, potential victims or intended use.",
            "Palo Alto Networks customers can be protected from the attacks outlined in this blog with the Next-Generation Firewall alongside DNS Security, URL Filtering and WildFire security subscriptions, and Cortex XDR.",
            "The code behavior and features strongly correlate with that of the WaterBear malware family, which has been active since as early as 2009.",
            "The malware is associated with the cyber espionage group BlackTech, which many in the broader threat research community have assessed to have ties to the Chinese government, and is believed to be responsible for recent attacks against several East Asian government organizations.",
            "The sample analyzed in this blog was identified by its connections to a malicious C2 domain published by Taiwan’s Ministry of Justice Investigation Bureau in August 2020."
        ]
    },
    {
	link：https://symantec-enterprise-blogs.security.com/blogs/threat-intelligence/palmerworm-blacktech-espionage-apt
        "report_id": "report_2",
        "sentences": [
            "Among the custom malware families we saw it use were:We have not observed the group using these malware families in previous attacks – they may be newly developed tools, or the evolution of older Palmerworm tools.",
            "As well as the four backdoors mentioned, we also see the group using a custom loader and a network reconnaissance tool, which Symantec detects as Trojan Horse and Hacktool.",
            "The Threat Hunter Team at Symantec, a division of Broadcom (NASDAQ: AVGO), has uncovered a new espionage campaign carried out by the Palmerworm group (aka BlackTech) involving a brand new suite of custom malware, targeting organizations in Japan, Taiwan, the U.S., and China.",
            "These tools provide attackers with a good degree of access to victim systems without the need to create complicated custom malware that can more easily be linked back to a specific group.",
            "We observed the group using previously unseen malware in these attacks.",
            "While the custom malware used in this attack is not malware we have seen used by Palmerworm before, some of the samples identified in this research are detected by other vendors as PLEAD, which is a known Palmerworm (aka Blacktech) malware family."
        ]
    },
    {
	link：https://blog.trendmicro.com/trendlabs-security-intelligence/waterbear-is-back-uses-api-hooking-to-evade-security-product-detection/
        "report_id": "report_3",
        "sentences": [
            "An attack group BlackTech has been actively conducting attacks against Japanese organisations since 2018.",
            "As BlackTech has been actively carrying out attacks, we will continue our analysis and monitoring.",
            "Since December 2012, he has been engaged in malware analysis and forensics investigation, and is especially involved in analyzing incidents of targeted attacks.",
            "This article introduces the details of the malware Gh0stTimes, which is used by this group.",
            "We have identified that servers infected with Gh0stTimes are also affected by other types of malware (downloader, backdoor, ELF Bifrose) and attack tools listed below.",
            "We would like to acknowledge the support and information shared by @r3dbU7z regarding this attack group."
        ]
    }
]